<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sinatra SSE Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
        h1 { color: #5a5a5a; }
        #sse-data { border: 1px solid #ccc; padding: 15px; min-height: 200px; background-color: #fff; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .event-item { margin-bottom: 8px; padding: 8px; border-radius: 4px; border-left-width: 5px; border-left-style: solid; }
        .event-message { border-left-color: #6c757d; background-color: #e9ecef; } /* Default messages */
        .event-update { border-left-color: #007bff; background-color: #cfe2ff; }  /* Blue for updates */
        .event-complete { border-left-color: #28a745; background-color: #d4edda; } /* Green for complete */
        .event-warning { border-left-color: #ffc107; background-color: #fff3cd; } /* Yellow for warnings */
        .event-error { border-left-color: #dc3545; background-color: #f8d7da; color: #721c24; } /* Red for errors */
        .event-connection { border-left-color: #17a2b8; background-color: #d1ecf1; } /* Info/Connection status */
        .event-type { font-weight: bold; margin-right: 10px; }
        pre { white-space: pre-wrap; word-wrap: break-word; background: #f8f9fa; padding: 5px; border-radius:3px; border: 1px solid #eee;}
    </style>
</head>
<body>
    <h1>Sinatra Server-Sent Events Test</h1>
    <p>Attempting to connect to <code>/stream-data</code>...</p>
    <div id="sse-data">Waiting for events...</div>

    <script>
        console.log("SSE client script loaded. Initializing EventSource.");
        const sseDataDiv = document.getElementById('sse-data');

        function addEventToPage(type, data, rawData) {
            const item = document.createElement('div');
            item.classList.add('event-item', `event-${type.toLowerCase()}`); // e.g., event-update, event-error

            const typeSpan = document.createElement('span');
            typeSpan.classList.add('event-type');
            typeSpan.textContent = `[${type.toUpperCase()}]`;
            item.appendChild(typeSpan);

            if (typeof data === 'object') {
                const dataPre = document.createElement('pre');
                dataPre.textContent = JSON.stringify(data, null, 2);
                item.appendChild(dataPre);
            } else {
                item.appendChild(document.createTextNode(data));
            }

            // Add raw data for debugging if needed
            // const rawDataSpan = document.createElement('small');
            // rawDataSpan.textContent = ` (Raw: ${rawData.substring(0,100)}...)`;
            // item.appendChild(rawDataSpan);

            if (sseDataDiv.innerHTML === "Waiting for events..." || sseDataDiv.innerHTML === "Connection closed or error.") {
                sseDataDiv.innerHTML = ""; // Clear initial message
            }
            sseDataDiv.appendChild(item);
            sseDataDiv.scrollTop = sseDataDiv.scrollHeight; // Scroll to bottom
        }

        // 1. Create EventSource object
        const eventSource = new EventSource('/stream-data');

        // 2. Handle connection opening
        eventSource.onopen = function(event) {
            console.log("Connection to server opened.");
            addEventToPage('CONNECTION', 'Stream opened successfully!', event.type);
        };

        // 3. Handle generic messages (those without a specific 'event:' line)
        eventSource.onmessage = function(event) {
            console.log("Message received:", event.data);
            // Try to parse as JSON, if not, display as text
            let parsedData = event.data;
            try {
                parsedData = JSON.parse(event.data);
            } catch (e) {
                // Not JSON, leave as is
            }
            addEventToPage('MESSAGE', parsedData, event.data);
        };

        // 4. Handle named events
        eventSource.addEventListener('update', function(event) {
            console.log("Update event received:", event.data);
            const data = JSON.parse(event.data);
            addEventToPage('UPDATE', data, event.data);
        });

        eventSource.addEventListener('complete', function(event) {
            console.log("Complete event received:", event.data);
            const data = JSON.parse(event.data);
            addEventToPage('COMPLETE', data, event.data);
            // The server might close the stream after 'complete'.
            // The EventSource object will automatically try to reconnect unless eventSource.close() is called.
            // For this demo, we'll assume the server handles closure properly.
            // If this is the definitive end, you might call eventSource.close() here.
            // eventSource.close();
            // console.log("EventSource closed by client after 'complete' event.");
            // addEventToPage('CONNECTION', 'Stream processing complete. Client closed connection.', 'info');
        });

        eventSource.addEventListener('warning', function(event) {
            console.log("Warning event received:", event.data);
            const data = JSON.parse(event.data);
            addEventToPage('WARNING', data, event.data);
        });

        // Handle server-sent 'error' events (custom application errors)
        eventSource.addEventListener('error', function(event) {
            // This is for custom 'event: error' messages FROM the server,
            // not for general EventSource connection errors.
            if (event.target.readyState === EventSource.OPEN && event.data) {
                 console.error("Custom error event received from server:", event.data);
                 const errorData = JSON.parse(event.data);
                 addEventToPage('ERROR', errorData, event.data);
            } else if (event.target.readyState === EventSource.CLOSED) {
                console.error("EventSource connection was closed by the server or lost.");
                addEventToPage('CONNECTION_ERROR', 'Connection closed or error. The server may have stopped or an error occurred.', 'error');
                eventSource.close(); // Ensure it's closed and doesn't try to reconnect.
            }
        });

        // 5. Handle EventSource connection errors (e.g., server down, network issue)
        eventSource.onerror = function(error) {
            console.error("EventSource failed:", error);
            addEventToPage('CONNECTION_ERROR', 'Connection error. Attempting to reconnect or stream ended.', 'error');
            // The EventSource object will automatically attempt to reconnect on most errors.
            // If the server explicitly closes the connection, readyState will be EventSource.CLOSED.
            // If it's a fatal error and no more events are expected, or server signals end.
            if (eventSource.readyState === EventSource.CLOSED) {
                 sseDataDiv.innerHTML = "Connection closed by server.";
                 console.log("EventSource connection definitively closed.");
            }
        };

        // Optional: Close the connection when the window is closed/unloaded
        window.addEventListener('beforeunload', function() {
            if (eventSource && eventSource.readyState !== EventSource.CLOSED) {
                console.log("Closing EventSource connection as page is unloading.");
                eventSource.close();
            }
        });

    </script>
</body>
</html>
